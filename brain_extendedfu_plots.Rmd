---
title: "BRAIN-ICU: Long-Term Followup among All Patients"
output:
  html_notebook:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(message = FALSE, fig.width = 8.5)
suppressPackageStartupMessages(library(googleVis))

## Option to print only chart aspect of googleVis objects, not full HTML
op <- options(gvis.plot.tag='chart')

library(tidyverse)
# library(googleVis)
library(viridis)

## -- Load data, stored in separate directory ------------------------------------------------------
if(Sys.info()['sysname'] == 'Darwin'){
  load('/Volumes/thomps23/ICUDelirium/BRAINICU/braindata.Rdata')
} else{
  load('/home/thomps23/ICUDelirium/BRAINICU/braindata.Rdata')  
}

```

The following plots show the progress of all BRAIN-ICU patients through the entirety of long-term
followup, up to six years after discharge from the index ICU admission.

# Data Management

```{r initial_datamgmt}
## -- Create data set with node values for each patient at each time point -------------------------
## Contains patients who did not withdraw in the hospital
keepPts <- subset(brain.oneobs, is.na(studywd.amt))$id

## How many (what %) of patients withdrew in hospital and are excluded?
rmPts <- setdiff(brain.oneobs$id, keepPts)
nPtsRm <- length(rmPts)
pctPtsRm <- round((nPtsRm / length(brain.oneobs$id))*100)

## Vectors of patient IDs for various subsets:
## MICU vs SICU admissions
ptsMICU <- subset(brain.oneobs, id %in% keepPts & icu.type == 'Medical')$id
ptsSICU <- subset(brain.oneobs, id %in% keepPts & icu.type == 'Surgical')$id

## Patients <, >= 65
ptsl65 <- subset(brain.oneobs, id %in% keepPts & age.enroll < 65)$id
ptsg65 <- subset(brain.oneobs, id %in% keepPts & age.enroll >= 65)$id

## Patients <, >= 75
ptsl75 <- subset(brain.oneobs, id %in% keepPts & age.enroll < 75)$id
ptsg75 <- subset(brain.oneobs, id %in% keepPts & age.enroll >= 75)$id

## -- Use brain.oneobs and brain.fu to determine whether, at each time point, patient was... -------
## -- deceased; unknown (followup only - no test score, withdrawn, lost to followup); alive, no ---- ## -- known impairment; alive, with impairment -----------------------------------------------------
## "Impairment" defined as...
## - IQCODE >= 3.6 at baseline
## - RBANS <=78, Trails A <=35 and/or Trails B <=35 at followup

## Create dummy data set with one record per patient per time point (inc. 12m mortality, since
## death may be entered there)
shell_df <- expand.grid(keepPts, 1:6)
names(shell_df) <- c('id', 'timept')

## Add timept variables to brain.oneobs, brain.fu
brain.oneobs$timept <- 1
brain.fu$timept <- with(brain.fu, ifelse(fu.period == '3 Month', 2,
                                  ifelse(fu.period == '12 Month', 3,
                                  ifelse(fu.period == '12 Month Mortality', 4,
                                  ifelse(fu.period == '4 year', 5, 6)))))

## Combine data needed to determine status at each time point
shell_df <- shell_df %>%
  left_join(dplyr::select(brain.oneobs, id, timept, died.inhosp, studywd, iqcode.score.e),
            by = c('id', 'timept')) %>%
  left_join(dplyr::select(brain.fu,
                          id, timept, status, rbans.global.score, trail.a.tscore, trail.b.tscore,
                          rbans.delayedmem.tscore),
            by = c('id', 'timept')) %>%
  ## Create indicators for whether patient died, withdrew at a given time point; these are absorbing
  ## states
  mutate(died_now = ifelse(timept == 1, died.inhosp == 'Died in hospital', status == 'Deceased'),
         wd_now = ifelse(timept == 1, studywd == 'Yes', status == 'Living-Withdrew from the study'))

## Figure out first time point of death, withdrawal for each patient
dfFirstDied <- shell_df %>%
  filter(died_now) %>%
  arrange(id, timept) %>%
  group_by(id) %>%
  summarise(firstDied = head(timept, n = 1))

dfFirstWD <- shell_df %>%
  filter(wd_now) %>%
  arrange(id, timept) %>%
  group_by(id) %>%
  summarise(firstWD = head(timept, n = 1))

## Merge death, withdrawal time points back onto shell data; determine current status at each time
brainStatus <- reduce(list(shell_df, dfFirstDied, dfFirstWD), .f = left_join, by = 'id') %>%
  ## 12m mortality "time point" only means anything if patient died; we've already got that info
  filter(timept != 4) %>%
  mutate(generalStatus = factor(ifelse(!is.na(firstDied) & timept >= firstDied, 6,
                                ifelse(!is.na(firstWD) & timept >= firstWD, 5,
                                ifelse(timept == 1 & iqcode.score.e < 3.6, 1,
                                ifelse(timept == 1, 2,
                                ifelse(is.na(rbans.global.score) & is.na(trail.a.tscore) &
                                         is.na(trail.b.tscore), 5,
                                ifelse((!is.na(rbans.global.score) & rbans.global.score <= 78) |
                                         (!is.na(trail.a.tscore) & trail.a.tscore <= 35) |
                                         (!is.na(trail.b.tscore) & trail.b.tscore <= 35), 4,
                                       3)))))),
                                levels = 1:6,
                                labels = c('No baseline impairment',
                                           'Mild CI at baseline',
                                           'Normal cognition',
                                           'Cognitive impairment',
                                           'Unknown',
                                           'Died')),
         generalStatusDM = factor(ifelse(!is.na(firstDied) & timept >= firstDied, 6,
                                  ifelse(!is.na(firstWD) & timept >= firstWD, 5,
                                  ifelse(timept == 1 & iqcode.score.e < 3.6, 1,
                                  ifelse(timept == 1, 2,
                                  ifelse(is.na(rbans.delayedmem.tscore), 5,
                                  ifelse((!is.na(rbans.delayedmem.tscore) &
                                            rbans.delayedmem.tscore <= 78), 4,
                                         3)))))),
                                  levels = 1:6,
                                  labels = c('No baseline impairment',
                                             'Mild CI at baseline',
                                             'Normal delayed memory',
                                             'Impaired delayed memory',
                                             'Unknown',
                                             'Died')),
         timelabel = ifelse(timept == 1 & generalStatus != 'Died', '',
                     ifelse(timept == 1, 'in hospital',
                     ifelse(timept == 2, '3m',
                     ifelse(timept == 3, '12m',
                     ifelse(timept == 5, '4yr', '6yr'))))),
         sourceNode = ifelse(timept == 1 & generalStatus != 'Died', as.character(generalStatus),
                      ifelse(timept == 1, paste(as.character(generalStatus), timelabel),
                             paste(as.character(generalStatus), timelabel, sep = ', '))),
         sourceNodeDM = ifelse(timept == 1 & generalStatus != 'Died', as.character(generalStatusDM),
                        ifelse(timept == 1, paste(as.character(generalStatusDM), timelabel),
                               paste(as.character(generalStatusDM), timelabel, sep = ', '))),
         ## Add indicator variables for faceting barcharts
         ageGroup65 = factor(ifelse(id %in% ptsg65, 1, 0), levels = 0:1, labels = c('<65', '>=65')),
         ageGroup75 = factor(ifelse(id %in% ptsg75, 1, 0), levels = 0:1, labels = c('<75', '>=75')),
         icuType = factor(ifelse(id %in% ptsMICU, 0,
                          ifelse(id %in% ptsSICU, 1, NA)),
                          levels = 0:1, labels = c('MICU', 'SICU'))) %>%
  arrange(id, timept)

```

Our starting point for is the `r nrow(brain.oneobs)` patients enrolled in BRAIN-ICU, aside from `r nPtsRm` (`r pctPtsRm`%) who withdrew in the hospital, leaving a total of **`r length(keepPts)`**.

Patients are classified as "unknown" at a given time point if they were, to the best of our
knowledge, still alive and had not withdrawn from the study, but have no assessment data available.
This could be because the followup team was unable to contact them at all, or could be because they
were contacted but had no or an incomplete assessment. This missingness is, therefore, quite likely
to be informative: patients who are sicker are less likely to complete an assessment, and it is
likely that these patients would have performed more poorly on those assessments.

# Broad Cognitive Impairment among Entire BRAIN-ICU Cohort
## Progress Throughout Study

### All Time Points
The following Sankey plot shows progression for all patients who remained in the study throughout
their hospital stay during the six years of BRAIN-ICU enrollment and followup, including all time
points (ICU admission and followup at 3 months, 12 months, 4 years and 6 years after discharge).

```{r sankey_functions}
## -- Function to create Sankey plot data given a data frame (brainStatus or a subset) -------------
## df: data.frame to start with
## keepNodes: which source/target nodes should we include? Default is to keep all.
##  1 = baseline, 2 = 3m, 3 = 12m, 5 = 4y, 6 = 6y (4 was 12m mortality form).
## impairType: global (default) or delayed memory RBANS
createSankeyData <- function(df = brainStatus,
                             keepNodes = 1:5,
                             impairType = c('overall', 'delayedmem')){
  
  ## impairType: whether to look at overall cognitive impairment or specifically delayed memory
  ## Default: overall
  impairType <- match.arg(impairType)
  
  ## If we're looking specifically at delayed memory, remove overall sourceNode variable and rename
  ## sourceNodeDM
  if(impairType == 'delayedmem'){
    df <- df %>%
      dplyr::select(-sourceNode) %>%
      rename(sourceNode = sourceNodeDM)
  }
  
  ## Create data.frame
  sankeyData <- df %>%
    filter(timept %in% keepNodes) %>%
    group_by(id) %>%
    mutate(targetNode = lead(sourceNode)) %>%
    ungroup() %>%
    filter(!is.na(targetNode)) %>%
    group_by(sourceNode, targetNode) %>%
    summarise(weight = n()) %>%
    ## Try arranging in the order I want to see if that works...
    separate(sourceNode, into = c('sourceStatus', 'sourceTime'),
             sep = ', ', remove = FALSE, fill = 'right') %>%
    separate(targetNode, into = c('targetStatus', 'targetTime'),
             sep = ', ', remove = FALSE, fill = 'right') %>%
    mutate(sourceStatusSort = ifelse(sourceStatus %in% c('Normal cognition',
                                                         'Normal delayed memory',
                                                         'No baseline impairment'),
                                     1,
                              ifelse(sourceStatus %in% c('Cognitive impairment',
                                                         'Impaired delayed memory',
                                                         'Mild CI at baseline'),
                                     2,
                              ifelse(sourceStatus %in% c('Died', 'Died in hospital'), 4, 3))),
           sourceTimeSort = ifelse(is.na(sourceTime), 1,
                            ifelse(sourceTime == '3m', 2,
                            ifelse(sourceTime == '12m', 3,
                            ifelse(sourceTime == '4yr', 4, 5)))),
           targetStatusSort = ifelse(targetStatus %in% c('Normal cognition',
                                                         'Normal delayed memory',
                                                         'No baseline impairment'),
                                     1,
                              ifelse(targetStatus %in% c('Cognitive impairment',
                                                         'Impaired delayed memory',
                                                         'Mild CI at baseline'),
                                     2,
                              ifelse(targetStatus %in% c('Died', 'Died in hospital'), 4, 3))),
           targetTimeSort = ifelse(is.na(targetTime), 1,
                            ifelse(targetTime == '3m', 2,
                            ifelse(targetTime == '12m', 3,
                            ifelse(targetTime == '4yr', 4, 5))))) %>%
    arrange(sourceTimeSort, sourceStatusSort, targetTimeSort, targetStatusSort) %>%
    dplyr::select(sourceNode, targetNode, weight, sourceTimeSort:targetStatusSort) %>%
    ungroup()
  
  ## Get total Ns for each sourceNode
  sourceNs <- sankeyData %>%
    group_by(sourceNode) %>%
    summarise(sourceN = sum(weight))
  
  ## Add Ns onto main sankeyData, create text for tooltip (transition, N / denom, %)
  sankeyData <- sankeyData %>%
    left_join(sourceNs, by = 'sourceNode') %>%
    mutate(info.tooltip = paste0('<b>', sourceNode, ' -> ', targetNode, ':</b><br>',
                                 weight, '/', sourceN, ' (', round((weight / sourceN)*100), '%)'))
  
  return(sankeyData)  
}

## -- Function to create googleVis Sankey plot using data from createSankeyData --------------------
createSankeyPlot <- function(sData){
  
  ## Does sData include all nodes at each time point, or just a subset?
  if(length(grep("Died", unique(sData$targetNode))) > 0){
    sankey_colors <- "'#3D7900', '#3D7900', '#AC0001', '#0057AC', 'black', '#AC0001', 'black', '#3D7900', '#AC0001', '#0057AC', 'black', '#3D7900', '#AC0001', '#0057AC', 'black', '#3D7900', '#AC0001', '#0057AC', 'black'"
  } else {
    sankey_colors <- "'#3D7900', '#3D7900', '#AC0001', '#AC0001', '#3D7900', '#AC0001'"
    ## no baseline impairment; normal, 12m; CI, 12m; mild CI at baseline; normal, 6y; CI, 6y
  }
  
  ## 0057AC: blue (unknown)
  ## 3D7900: green (normal)
  ## AC0001: red (impaired)
  ## black: died
  
  ## Create string to specify all sankey options
  sankey_options <- paste("{link: { colorMode: 'gradient' },
                            node: { colors: [", sankey_colors, "],
                                    label: { color: '#003D79',
                                             fontSize: 14,
                                             bold: true } },
                                    iterations: 0
                           }")
  
  ## Create googleVis object
  gvisBRAIN <- gvisSankey(sData,
                          from = 'sourceNode',
                          to = 'targetNode',
                          weight = 'weight',
                          options = list(height = 600, width = 800, tooltip = "{isHtml:'True'}",
                                         sankey = sankey_options))
}

```

```{r sankey_overall}
sankeyDataAll <- createSankeyData()
sankeyPlotAll <- createSankeyPlot(sankeyDataAll)

```

```{r print_sankey, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotAll, tag = 'chart')

```

### Baseline and 12 Months Only, All Patients
This plot shows one-year progression for all BRAIN-ICU patients who remained in the study throughout
their hospital stay.

```{r sankey_overall_base12}
sankeyDataBase12 <- createSankeyData(keepNodes = c(1, 3))
sankeyPlotBase12 <- createSankeyPlot(sankeyDataBase12)

```

```{r print_sankey_base12, results = 'asis'}
## For creating separate file
# print(sankeyPlotBase12, file = 'brain_phase3_sankey_base12.html')
print(sankeyPlotBase12, tag = 'chart')

```

### Baseline and 12 Months Only, Patients Assessed at Each Point
This plot shows cognitive impairment at ICU admission and 12-month followup for all patients who
were assessed at *both* time points (IQCODE at ICU admission, RBANS global/Trails B at followup).

```{r sankey_assessed_base12}
assessed_base <- subset(shell_df, timept == 1 & !died_now & !wd_now)$id
assessed_12m <- subset(shell_df,
                       timept == 3 & (!is.na(rbans.global.score) | !is.na(trail.b.tscore)))$id

brainStatusAssessed12 <- subset(brainStatus, id %in% intersect(assessed_base, assessed_12m))

sankeyDataAssessedBase12 <- createSankeyData(df = brainStatusAssessed12, keepNodes = c(1, 3))
sankeyPlotAssessedBase12 <- createSankeyPlot(sankeyDataAssessedBase12)

```

```{r print_sankey_assessed_base12, results = 'asis'}
## For creating separate file
# print(sankeyPlotAssessedBase12, file = 'brain_phase3_sankey_assessed_base12.html')
print(sankeyPlotAssessedBase12, tag = 'chart')

```

### Baseline, 12 Months and 6 Years Only, All Patients
This plot shows the progression of all patients who remained in the study throughout their hospital
stay at 12-month and 6-year followup.

```{r sankey_overall_base126}
sankeyDataBase126 <- createSankeyData(keepNodes = c(1, 3, 6))
sankeyPlotBase126 <- createSankeyPlot(sankeyDataBase126)

```

```{r print_sankey_base126, results = 'asis'}
## For creating separate file
# print(sankeyPlotBase126, file = 'brain_phase3_sankey_base126.html')
print(sankeyPlotBase126, tag = 'chart')

```

### Baseline, 12 Months and 6 Years Only, Patients Assessed at Each Point
This plot shows progression of all patients who were assessed at baseline (IQCODE), 12-month *and* 6-year followup (RBANS global/Trails B).

```{r sankey_assessed_base126}
assessed_6y <- subset(shell_df,
                      timept == 6 & (!is.na(rbans.global.score) | !is.na(trail.b.tscore)))$id

brainStatusAssessed126 <- subset(brainStatus, id %in% intersect(assessed_12m, assessed_6y))

sankeyDataAssessedBase126 <- createSankeyData(df = brainStatusAssessed126, keepNodes = c(1, 3, 6))
sankeyPlotAssessedBase126 <- createSankeyPlot(sankeyDataAssessedBase126)

```

```{r print_sankey_assessed_base126, results = 'asis'}
## For creating separate file
# print(sankeyPlotAssessedBase126, file = 'brain_phase3_sankey_assessed_base126.html')
print(sankeyPlotAssessedBase126, tag = 'chart')

```

## Status at Each Time Point, All Patients

The plot below shows status (normal, impaired, unknown, or deceased) at each time point as a
proportion of all `r length(keepPts)` patients who remained in the study during and after their
hospital stay. "Unknown" is a combination of patients who withdrew during followup, who could not be
contacted, and who had incomplete assessments.

```{r bar_functions}

createBarData <- function(df = brainStatus,
                          facetVar = NULL,
                          impairType = c('overall', 'delayedmem')){
  
  ## impairType: whether to look at overall cognitive impairment or specifically delayed memory
  ## Default: overall
  impairType <- match.arg(impairType)
  
  ## If we're looking specifically at delayed memory, remove overall generalStatus variable and
  ## rename generalStatusDM; set text for impairment-related factor labels
  if(impairType == 'delayedmem'){
    df <- df %>%
      dplyr::select(-generalStatus) %>%
      rename(generalStatus = generalStatusDM)
    
    noImpText <- 'No imp.'
    ImpText <- 'Imp.'
  } else{
    noImpText <- 'No CI'
    ImpText <- 'CI'
  }
  
  ## Set grouping columns: always by time point, including faceting variable if specified
  if(!is.null(facetVar)){
    groupCols <- c('timept', facetVar)
  } else{
    groupCols <- 'timept'
  }
  
  df %>%
    group_by_(.dots = groupCols) %>%
    summarise(propNormal = mean(generalStatus %in% c('No baseline impairment',
                                                     'Normal delayed memory',
                                                     'Normal cognition'),
                                na.rm = TRUE),
              propImpaired = mean(generalStatus %in% c('Mild CI at baseline',
                                                       'Impaired delayed memory',
                                                       'Cognitive impairment'),
                                  na.rm = TRUE),
              propUnknown = mean(generalStatus == 'Unknown', na.rm = TRUE),
              propDied = mean(generalStatus == 'Died', na.rm = TRUE)) %>%
    gather(key = status, value = proportion, propNormal:propDied) %>%
    mutate(time.f = factor(timept,
                           levels = c(1:3, 5:6),
                           labels = c('In-Hospital', '3 Months', '12 Months',
                                      '4 Years', '6 Years')),
           status.f = factor(ifelse(timept == 1 & status == 'propNormal', 1,
                             ifelse(timept == 1 & status == 'propImpaired', 2,
                             ifelse(timept == 1 & status == 'propDied', 3,
                             ifelse(status == 'propNormal', 4,
                             ifelse(status == 'propImpaired', 5,
                             ifelse(status == 'propUnknown', 6,
                             ifelse(status == 'propDied', 7, NA))))))),
                             levels = 1:7,
                             labels = c('No\nbaseline\nCI',
                                        'Mild\nCI,\nbaseline',
                                        'Died\nin\nhospital',
                                        noImpText,
                                        ImpText,
                                        'Unknown',
                                        'Died'))) %>%
    filter(proportion > 0)
}

createBarPlot <- function(df,
                          facetVar = NULL,
                          plotTitle,
                          captionProp,
                          captionCI = '"Cognitive impairment" (CI) is defined by RBANS global score <=78 and/or Trailmaking A or B score <=35.'){
  
  catColors <- viridis(4)
  if(length(unique(subset(df, timept > 1)$status.f)) == 3){
    catColors <- catColors[1:3]
  } else if(length(unique(subset(df, timept > 1)$status.f)) == 2){
    catColors <- catColors[2:3]
  }
  
  p <- ggplot(data = df, aes(x = status.f, y = proportion))
  
  if(!is.null(facetVar)){
    p <- p + facet_grid(as.formula(paste(facetVar, '~ time.f')), scales = 'free_x', drop = TRUE)
    axisYSize <- 6.5
  } else{
    p <- p +
      facet_wrap(~ time.f, scales = 'free_x', nrow = 1, drop = TRUE)
    axisYSize <- 9
  }
  
  p <- p +
    geom_bar(aes(fill = status), stat = 'identity') +
    scale_fill_manual(values = catColors) +
    scale_x_discrete(name = NULL) +
    scale_y_continuous(name = NULL,
                       limits = c(0, 1),
                       breaks = seq(0, 1, 0.1),
                       labels = paste0(seq(0, 1, 0.1)*100, '%')) +
    labs(title = plotTitle, caption = paste0(captionProp, '\n', captionCI)) +
    theme(legend.position = 'none',
          strip.text = element_text(face = 'bold'),
          axis.ticks.x = element_blank(),
          axis.text.x = element_text(size = 7.5),
          axis.text.y = element_text(size = axisYSize),
          plot.caption = element_text(face = 'italic', colour = 'grey40'))
  
  return(p)
}
  
```

```{r bar_allpts}
bardataAll <- createBarData()
ggbarAll <- createBarPlot(df = bardataAll,
                          plotTitle = 'Status by Time Point among All Patients',
                          captionProp = paste('Proportion of all',
                                              length(keepPts),
                                              'patients who remained in the study throughout their hospital stay.'))

```

```{r print_bar_allpts, results = 'asis'}
ggbarAll

```

## Status at Each Time Point, Patients with Known Status

The plot below shows status (normal, impaired, or deceased) at each time point as a proportion of
all patients for whom status is known at each time point.

```{r bar_knownpts}
bardataKnown <- createBarData(brainStatus %>% filter(generalStatus != 'Unknown'))
ggbarKnown <- createBarPlot(df = bardataKnown,
                            plotTitle = 'Status by Time Point among Patients with Known Status',
                            captionProp = 'Proportion of patients who had complete cognitive assessments or were known to be deceased.')

```

```{r print_bar_knownpts, results = 'asis'}
ggbarKnown

```

## Status at Each Time Point, Patients with Complete Assessment

The plot below shows status (normal or impaired) at each time point as a proportion of all patients
who had a complete cognitive assessment (or survived the hospital stay, in panel 1) at each time
point.

```{r bar_assessedpts}
bardataAssessed <- createBarData(brainStatus %>% filter(!(generalStatus %in% c('Died', 'Unknown')))) 
ggbarAssessed <-
  createBarPlot(df = bardataAssessed,
                plotTitle = 'Status by Time Point among Patients with Complete Assessments',
                captionProp = 'Proportion of patients who had complete cognitive assessments (or survived hospital stay, Panel 1).')

```

```{r print_bar_assessedpts, results = 'asis'}
ggbarAssessed

```

# Impaired Delayed Memory among Entire BRAIN-ICU Cohort
## Progress Throughout Study

```{r sankey_delayed}
sankeyDataDM <- createSankeyData(impairType = 'delayedmem')
sankeyPlotDM <- createSankeyPlot(sankeyDataDM)

```

```{r print_sankey_delayed, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotDM, tag = 'chart')

```

## Delayed Memory at Each Time Point, All Patients
```{r bar_dm_allpts}
bardataDMAll <- createBarData(impairType = 'delayedmem')
ggbarDMAll <- createBarPlot(df = bardataDMAll,
                            plotTitle = 'Delayed Memory by Time Point among All Patients',
                            captionProp = paste0('Proportion of all',
                                                 length(keepPts),
                                                 'patients who remained in the study throughout their hospital stay.'),
                            captionCI = '"Impairment" defined by RBANS delayed memory score <= 78.')

```

```{r print_bar_dm_allpts, results = 'asis'}
ggbarDMAll

```

## Delayed Memory at Each Time Point, Patients with Known Status
```{r bar_dm_known}
bardataDMKnown <- createBarData(df = brainStatus %>% filter(generalStatusDM != 'Unknown'),
                                impairType = 'delayedmem')
ggbarDMKnown <- createBarPlot(df = bardataDMKnown,
                              plotTitle = 'Delayed Memory by Time Point among Patients with Known Status',
                              captionProp = 'Proportion of patients who had RBANS delayed memory scores or were known to be deceased.',
                              captionCI = '"Impairment" defined by RBANS delayed memory score <= 78.')

```

```{r print_bar_dm_known, results = 'asis'}
ggbarDMKnown

```


## Delayed Memory at Each Time Point, Patients with Complete Assessment

The plot below shows status (normal or impaired) at each time point as a proportion of all patients
who had a complete delayed memory assessment (or survived the hospital stay, in panel 1) at each time point.

```{r bar_dm_assessedpts}
bardataDMAssessed <- createBarData(brainStatus %>%
                                     filter(!(generalStatusDM %in% c('Died', 'Unknown'))),
                                   impairType = 'delayedmem')
ggbarDMAssessed <-
  createBarPlot(df = bardataDMAssessed,
                plotTitle = 'Delayed Memory by Time Point among Patients with Complete Assessments',
                captionProp = 'Proportion of patients who had RBANS delayed memory scores.',
                              captionCI = '"Impairment" defined by RBANS delayed memory score <= 78.')

```

```{r print_bar_dm_assessedpts, results = 'asis'}
ggbarDMAssessed

```

# Cognitive Impairment by Age Group

We want to see whether the progression and incidence of cognitive impairment is different for older
vs younger patients. We'll define "older" in two ways: >=65 and >=75 years old at the time of
initial BRAIN-ICU enrollment.

## <65 vs >=65 at Enrollment
### Progress Throughout Study

```{r sankey_65}
sankeyDatag65 <- createSankeyData(df = brainStatus %>% filter(id %in% ptsg65))
sankeyPlotg65 <- createSankeyPlot(sankeyDatag65)

sankeyDatal65 <- createSankeyData(df = brainStatus %>% filter(id %in% ptsl65))
sankeyPlotl65 <- createSankeyPlot(sankeyDatal65)

```

#### Patients >= 65 at Enrollment
```{r print_sankey_g65, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotg65, tag = 'chart')

```

#### Patients < 65 at Enrollment
```{r print_sankey_l65, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotl65, tag = 'chart')

```

### Status at Each Time Point, All Patients

```{r bar_65_allpts}
bardata65All <- createBarData(facetVar = 'ageGroup65')
ggbar65All <- createBarPlot(df = bardata65All,
                            facetVar = 'ageGroup65',
                            plotTitle = 'Status by Time Point among All Patients, Split at Age 65',
                            captionProp = paste('Proportion of all patients who remained in the study throughout their hospital stay.'))

```

```{r print_bar_65_allpts, results = 'asis'}
ggbar65All

```

### Status at Each Time Point, Patients with Known Status

The plot below shows status (normal, impaired, or deceased) at each time point as a proportion of
all patients for whom status is known at each time point.

```{r bar_65_knownpts}
bardata65Known <- createBarData(brainStatus %>% filter(generalStatus != 'Unknown'),
                                facetVar = 'ageGroup65')
ggbar65Known <- createBarPlot(df = bardata65Known,
                              facetVar = 'ageGroup65',
                              plotTitle = 'Status by Time Point among Patients with Known Status, Split at Age 65',
                              captionProp = 'Proportion of patients who had complete cognitive assessments or were known to be deceased.')

```

```{r print_bar_65_knownpts, results = 'asis'}
ggbar65Known

```

### Status at Each Time Point, Patients with Complete Assessment

The plot below shows status (normal or impaired) at each time point as a proportion of all patients
who had a complete cognitive assessment (or survived the hospital stay, in panel 1) at each time
point.

```{r bar_65_assessedpts}
bardata65Assessed <- createBarData(brainStatus %>%
                                     filter(!(generalStatus %in% c('Died', 'Unknown'))),
                                   facetVar = 'ageGroup65')
ggbar65Assessed <-
  createBarPlot(df = bardata65Assessed,
                facetVar = 'ageGroup65',
                plotTitle = 'Status by Time Point among Patients with Complete Assessments, Split at Age 65',
                captionProp = 'Proportion of patients who had complete cognitive assessments (or survived hospital stay, Panel 1).')

```

```{r print_bar_65_assessedpts, results = 'asis'}
ggbar65Assessed

```

## <75 vs >=75 at Enrollment
### Progress Throughout Study

```{r sankey_75}
sankeyDatag75 <- createSankeyData(df = brainStatus %>% filter(id %in% ptsg75))
sankeyPlotg75 <- createSankeyPlot(sankeyDatag75)

sankeyDatal75 <- createSankeyData(df = brainStatus %>% filter(id %in% ptsl75))
sankeyPlotl75 <- createSankeyPlot(sankeyDatal75)

```

#### Patients >= 75 at Enrollment
```{r print_sankey_g75, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotg75, tag = 'chart')

```

#### Patients < 75 at Enrollment
```{r print_sankey_l75, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotl75, tag = 'chart')

```

### Status at Each Time Point, All Patients

```{r bar_75_allpts}
bardata75All <- createBarData(facetVar = 'ageGroup75')
ggbar75All <- createBarPlot(df = bardata75All,
                            facetVar = 'ageGroup75',
                            plotTitle = 'Status by Time Point among All Patients, Split at Age 75',
                            captionProp = paste('Proportion of all patients who remained in the study throughout their hospital stay.'))

```

```{r print_bar_75_allpts, results = 'asis'}
ggbar75All

```

### Status at Each Time Point, Patients with Known Status

The plot below shows status (normal, impaired, or deceased) at each time point as a proportion of
all patients for whom status is known at each time point.

```{r bar_75_knownpts}
bardata75Known <- createBarData(brainStatus %>% filter(generalStatus != 'Unknown'),
                                facetVar = 'ageGroup75')
ggbar75Known <- createBarPlot(df = bardata75Known,
                              facetVar = 'ageGroup75',
                              plotTitle = 'Status by Time Point among Patients with Known Status, Split at Age 75',
                              captionProp = 'Proportion of patients who had complete cognitive assessments or were known to be deceased.')

```

```{r print_bar_75_knownpts, results = 'asis'}
ggbar75Known

```

### Status at Each Time Point, Patients with Complete Assessment

The plot below shows status (normal or impaired) at each time point as a proportion of all patients
who had a complete cognitive assessment (or survived the hospital stay, in panel 1) at each time
point.

```{r bar_75_assessedpts}
bardata75Assessed <- createBarData(brainStatus %>%
                                     filter(!(generalStatus %in% c('Died', 'Unknown'))),
                                   facetVar = 'ageGroup75')
ggbar75Assessed <-
  createBarPlot(df = bardata75Assessed,
                facetVar = 'ageGroup75',
                plotTitle = 'Status by Time Point among Patients with Complete Assessments, Split at Age 75',
                captionProp = 'Proportion of patients who had complete cognitive assessments (or survived hospital stay, Panel 1).')

```

```{r print_bar_75_assessedpts, results = 'asis'}
ggbar75Assessed

```

# MICU vs SICU Admissions
The following plots show impairment for patients admitted to the MICU vs the SICU.

## Progress Throughout Study

```{r sankey_icu}
sankeyDataMI <- createSankeyData(df = brainStatus %>% filter(id %in% ptsMICU))
sankeyPlotMI <- createSankeyPlot(sankeyDataMI)

sankeyDataSI <- createSankeyData(df = brainStatus %>% filter(id %in% ptsSICU))
sankeyPlotSI <- createSankeyPlot(sankeyDataSI)

```

### MICU Patients
```{r print_sankey_mi, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotMI, tag = 'chart')

```

### SICU Patients
```{r print_sankey_si, results = 'asis'}
## For creating separate file
# print(gvisBRAIN, file = 'brain_phase3_sankey.html')
print(sankeyPlotSI, tag = 'chart')

```

## Status at Each Time Point, All Patients

```{r bar_ICU_allpts}
bardataICUAll <- createBarData(facetVar = 'icuType')
ggbarICUAll <- createBarPlot(df = bardataICUAll,
                             facetVar = 'icuType',
                             plotTitle = 'Status by Time Point among All Patients by ICU Type',
                             captionProp = paste('Proportion of all patients who remained in the study throughout their hospital stay.'))

```

```{r print_bar_ICU_allpts, results = 'asis'}
ggbarICUAll

```

### Status at Each Time Point, Patients with Known Status

The plot below shows status (normal, impaired, or deceased) at each time point as a proportion of
all patients for whom status is known at each time point.

```{r bar_ICU_knownpts}
bardataICUKnown <- createBarData(brainStatus %>% filter(generalStatus != 'Unknown'),
                                 facetVar = 'icuType')
ggbarICUKnown <- createBarPlot(df = bardataICUKnown,
                               facetVar = 'icuType',
                               plotTitle = 'Status by Time Point among Patients with Known Status by ICU Type',
                               captionProp = 'Proportion of patients who had complete cognitive assessments or were known to be deceased.')

```

```{r print_bar_ICU_knownpts, results = 'asis'}
ggbarICUKnown

```

### Status at Each Time Point, Patients with Complete Assessment

The plot below shows status (normal or impaired) at each time point as a proportion of all patients
who had a complete cognitive assessment (or survived the hospital stay, in panel 1) at each time
point.

```{r bar_ICU_assessedpts}
bardataICUAssessed <- createBarData(brainStatus %>%
                                      filter(!(generalStatus %in% c('Died', 'Unknown'))),
                                    facetVar = 'icuType')
ggbarICUAssessed <-
  createBarPlot(df = bardataICUAssessed,
                facetVar = 'icuType',
                plotTitle = 'Status by Time Point among Patients with Complete Assessments by ICU Type',
                captionProp = 'Proportion of patients who had complete cognitive assessments (or survived hospital stay, Panel 1).')

```

```{r print_bar_ICU_assessedpts, results = 'asis'}
ggbarICUAssessed

```

# Patients with Unknown Status
```{r unknowns}
## List of all unknown patients
unknown.ids <- unique(subset(brainStatus, timept == 6 & generalStatus == 'Unknown')$id)

## For each one, list status at each time point, along with birth, death, withdrawal dates
unknown.data <- brain.oneobs %>%
  filter(id %in% unknown.ids) %>%
  dplyr::select(id, birth.date)

## Write to CSV; may be better for Amy/Erin
write_csv(unknown.data, path = "brain_unknown_6yrs.csv")

```

To assist the followup team, the IDs and birth dates of all `r length(unknown.ids)` patients whose
status is "Unknown" at 6-year followup are shown below. For convenience, a downloadable CSV file is
[also available on Box](https://vumc.box.com/s/fz4qpms9hlsa9q2kq8746n8zhgn0ze7h) (must have permissions to access).

```{r show_unknowns}
unknown.data

```

